--[[
    Safe Universal Remote Spy (V2 - Hooking Method)
    This script hooks the global 'firesignal' function to safely log all
    client-side remote event calls without disabling connections or crashing the game.

    -- HOW TO USE --
    1. Execute this script. A log window will appear on the right.
    2. Play the game and perform an action that gives you an item (buy, pickup, quest).
    3. The spy window will populate with the exact remote index and arguments used.
    4. Use this information to configure your item spawner.
]]

-- Ensure this script only runs once
if getgenv().RemoteSpyActive then return end
getgenv().RemoteSpyActive = true

--//=======================================================================\\
--|| GUI SETUP
--\\=======================================================================//

local spyGui = Instance.new("ScreenGui")
local logFrame = Instance.new("ScrollingFrame")
local uiListLayout = Instance.new("UIListLayout")
local title = Instance.new("TextLabel")

spyGui.Name = "SafeRemoteSpyGUI"
spyGui.ResetOnSpawn = false
logFrame.Name = "LogFrame"
logFrame.Size = UDim2.new(0.4, 0, 0.5, 0)
logFrame.Position = UDim2.new(0.6, -10, 0, 40)
logFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
logFrame.BackgroundTransparency = 0.3
logFrame.BorderColor3 = Color3.fromRGB(120, 120, 120)
uiListLayout.Parent = logFrame
logFrame.Parent = spyGui

title.Name = "Title"
title.Size = UDim2.new(0.4, 0, 0, 30)
title.Position = UDim2.new(0.6, -10, 0, 10)
title.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
title.BorderColor3 = Color3.fromRGB(120, 120, 120)
title.Text = "Safe Remote Spy - Waiting for Events..."
title.Font = Enum.Font.SourceSansSemibold
title.TextColor3 = Color3.new(1,1,1)
title.Parent = spyGui
spyGui.Parent = game:GetService("CoreGui")

--//=======================================================================\\
--|| SPY LOGIC
--\\=======================================================================//

-- Store the original firesignal function before we overwrite it
local oldFireSignal = firesignal

-- Pre-cache the remotes for faster lookups
local eventsFolder = game:GetService("ReplicatedStorage"):WaitForChild("Communication"):WaitForChild("Events")
local remoteCache = eventsFolder:GetChildren()

local function formatTable(tbl, indent)
    indent = indent or 0
    local str = "{\n"
    for k, v in pairs(tbl) do
        local keyStr = (typeof(k) == "string") and "[\"" .. k .. "\"]" or "[" .. tostring(k) .. "]"
        str = str .. string.rep("  ", indent + 1) .. keyStr .. " = "
        if typeof(v) == "table" then
            str = str .. formatTable(v, indent + 1) .. ",\n"
        elseif typeof(v) == "string" then
            str = str .. "\"" .. tostring(v) .. "\",\n"
        else
            str = str .. tostring(v) .. ",\n"
        end
    end
    str = str .. string.rep("  ", indent) .. "}"
    return str
end

-- Overwrite the global firesignal function with our spy
firesignal = function(remote, ...)
    local args = {...}

    -- Our logging logic
    if typeof(remote) == "Instance" and remote:IsA("RemoteEvent") and remote.Name == "" then
        -- Find the index of this remote
        for i, v in ipairs(remoteCache) do
            if v == remote then
                local formattedArgs = formatTable(args)
                
                -- Log to console
                print("--- [SPY] Remote Fired ---")
                print("Remote Index: #" .. i)
                print("Arguments Table:", formattedArgs)
                print("--------------------------")

                -- Log to GUI
                title.Text = "Event Captured! Index: #" .. i
                title.TextColor3 = Color3.fromRGB(0, 255, 0)

                local logLabel = Instance.new("TextLabel")
                logLabel.Text = "Index: #" .. i .. "\nArgs: " .. formattedArgs
                logLabel.TextColor3 = Color3.new(1, 1, 1)
                logLabel.TextWrapped = true
                logLabel.TextXAlignment = Enum.TextXAlignment.Left
                logLabel.Size = UDim2.new(1, -10, 0, 120) -- Increased size for better readability
                logLabel.BackgroundTransparency = 1
                logLabel.Font = Enum.Font.Code
                logLabel.Parent = logFrame
                
                break -- Stop searching once we've found it
            end
        end
    end

    -- MOST IMPORTANT STEP: Call the original function to keep the game running
    return oldFireSignal(remote, ...)
end

print("Safe Remote Spy (Hooking Method) is now active.")
