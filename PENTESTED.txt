--[[
    Ultimate Remote Spy (V3 - __namecall Hooking)
    This script hooks the core __namecall metamethod to intercept all :Method() calls.
    It filters for ':FireServer()' on the target remotes, making it the most
    reliable way to spy on client-server communication.

    -- HOW TO USE --
    1. Execute this script. The log window will appear.
    2. Go play the game and acquire an item through any normal means.
    3. The spy will capture the event and display the exact remote index and arguments.
       This method is guaranteed to work if the action is client-initiated.
]]

-- Ensure this script only runs once to avoid multiple hooks
if getgenv().NamecallSpyActive then return end
getgenv().NamecallSpyActive = true

--//=======================================================================\\
--|| GUI SETUP (Same as before for consistency)
--\\=======================================================================//

local spyGui = Instance.new("ScreenGui")
local logFrame = Instance.new("ScrollingFrame")
local uiListLayout = Instance.new("UIListLayout")
local title = Instance.new("TextLabel")
spyGui.Name = "NamecallSpyGUI"
spyGui.ResetOnSpawn = false
logFrame.Name = "LogFrame"
logFrame.Size = UDim2.new(0.4, 0, 0.5, 0)
logFrame.Position = UDim2.new(0.6, -10, 0, 40)
logFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
logFrame.BackgroundTransparency = 0.3
logFrame.BorderColor3 = Color3.fromRGB(120, 120, 120)
uiListLayout.Parent = logFrame
logFrame.Parent = spyGui
title.Name = "Title"
title.Size = UDim2.new(0.4, 0, 0, 30)
title.Position = UDim2.new(0.6, -10, 0, 10)
title.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
title.BorderColor3 = Color3.fromRGB(120, 120, 120)
title.Text = "Ultimate Spy - Waiting for :FireServer()..."
title.Font = Enum.Font.SourceSansSemibold
title.TextColor3 = Color3.new(1,1,1)
title.Parent = spyGui
spyGui.Parent = game:GetService("CoreGui")

--//=======================================================================\\
--|| SPY LOGIC
--\\=======================================================================//

local function formatTable(tbl, indent)
    indent = indent or 0
    local str = "{\n"
    for k, v in pairs(tbl) do
        local keyStr = (typeof(k) == "string") and "[\"" .. k .. "\"]" or "[" .. tostring(k) .. "]"
        str = str .. string.rep("  ", indent + 1) .. keyStr .. " = "
        if typeof(v) == "table" then
            str = str .. formatTable(v, indent + 1) .. ",\n"
        elseif typeof(v) == "string" then
            str = str .. "\"" .. tostring(v) .. "\",\n"
        else
            str = str .. tostring(v) .. ",\n"
        end
    end
    str = str .. string.rep("  ", indent) .. "}"
    return str
end

-- Pre-cache the remotes for fast lookups
local eventsFolder = game:GetService("ReplicatedStorage"):WaitForChild("Communication"):WaitForChild("Events")
local remoteCache = eventsFolder:GetChildren()

-- Get the game's metatable and hook __namecall
local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall

mt.__namecall = function(...)
    local args = {...}
    local self = args[1]
    local method = getnamecallmethod()

    -- Our spy check
    if method == "FireServer" and typeof(self) == "Instance" and self:IsA("RemoteEvent") and self.Name == "" then
        -- We found one! Now find its index.
        for i, remote in ipairs(remoteCache) do
            if remote == self then
                -- Package the real arguments (everything after 'self')
                local fireArgs = {}
                for j = 2, #args do
                    table.insert(fireArgs, args[j])
                end
                
                local formattedArgs = formatTable(fireArgs)
                
                -- Log everything
                print("--- [ULTIMATE SPY] FireServer Captured ---")
                print("Remote Index: #" .. i)
                print("Arguments Table:", formattedArgs)
                print("------------------------------------------")

                title.Text = "FireServer Captured! Index: #" .. i
                title.TextColor3 = Color3.fromRGB(0, 255, 0)

                local logLabel = Instance.new("TextLabel")
                logLabel.Text = "Index: #" .. i .. "\nArgs: " .. formattedArgs
                logLabel.TextColor3 = Color3.new(1, 1, 1)
                logLabel.TextWrapped = true
                logLabel.TextXAlignment = Enum.TextXAlignment.Left
                logLabel.Size = UDim2.new(1, -10, 0, 150)
                logLabel.BackgroundTransparency = 1
                logLabel.Font = Enum.Font.Code
                logLabel.Parent = logFrame
                
                break -- Stop searching
            end
        end
    end

    -- MOST IMPORTANT: Call the original namecall to keep the game from breaking
    return oldNamecall(...)
end

print("Ultimate Spy (__namecall Hook) is now active.")
